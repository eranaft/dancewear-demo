<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Studio Wear ‚Ä¢ Demo</title>
  <style>
    :root{
      --bg:#f6f5f3;
      --card:#ffffff;
      --text:#141417;
      --muted:#6e6e77;
      --accent:#141417;
      --line: rgba(20,20,23,.10);
      --shadow: 0 16px 50px rgba(20,20,23,.08);
      --radius: 22px;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 20% -10%, rgba(0,0,0,.05), transparent 60%),
        radial-gradient(700px 500px at 90% 10%, rgba(0,0,0,.04), transparent 55%),
        var(--bg);
      -webkit-tap-highlight-color: transparent;
    }

    .container{
      max-width: 980px;
      margin: 0 auto;
      padding: 0 14px;
    }

    header{
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(246,245,243,.78);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--line);
    }
    .head{
      padding: 14px 0 10px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 0;
    }
    .title{
      font-size: clamp(18px, 3.8vw, 22px);
      font-weight: 950;
      letter-spacing: .2px;
      line-height: 1.1;
    }
    .subtitle{
      color:var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }
    .pill{
      flex: 0 0 auto;
      background: rgba(20,20,23,.06);
      border: 1px solid rgba(20,20,23,.08);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 800;
      color: var(--text);
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
      transition: transform .18s ease;
      white-space: nowrap;
    }
    .pill small{
      font-weight: 900;
      color: rgba(20,20,23,.55);
    }
    .bump{ animation: bump .28s ease; }
    @keyframes bump{ 0%{transform:scale(1)} 35%{transform:scale(1.11)} 100%{transform:scale(1)} }

    main{
      padding: 14px 0 96px;
    }

    /* toolbar */
    .toolbar{
      background: rgba(255,255,255,.80);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap: wrap;
    }

    input, textarea{
      width:100%;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.9);
      padding: 12px 14px;
      color: var(--text);
      outline: none;
      font-weight: 650;
      min-width: 0;
    }
    input:focus, textarea:focus{
      border-color: rgba(20,20,23,.28);
      box-shadow: 0 0 0 4px rgba(20,20,23,.06);
    }
    textarea{ min-height: 90px; resize: vertical; }

    .chip{
      width: auto;
      border: 1px solid var(--line);
      background: rgba(20,20,23,.04);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 900;
      cursor:pointer;
      transition: transform .18s ease, box-shadow .18s ease, background .18s ease;
      user-select:none;
    }
    .chip:active{ transform: scale(.98); }
    .chip.active{
      background: rgba(20,20,23,.92);
      color:#fff;
      border-color: rgba(20,20,23,.92);
      box-shadow: 0 12px 30px rgba(20,20,23,.18);
    }

    /* grid */
    .grid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      align-items: stretch;
    }

    /* product cards */
    .productCard{
      background: rgba(255,255,255,.88);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
      transition: transform .18s ease, box-shadow .18s ease;
      display:flex;
      flex-direction:column;
      min-width: 0;
    }
    @media (hover:hover){
      .productCard:hover{
        transform: translateY(-2px);
        box-shadow: 0 22px 64px rgba(20,20,23,.12);
      }
    }
    .productCard:active{ transform: scale(.99); }

    .pImg{
      position: relative;
      height: 150px;
      background:
        radial-gradient(220px 120px at 30% 25%, rgba(20,20,23,.14), transparent 60%),
        radial-gradient(180px 120px at 70% 60%, rgba(20,20,23,.10), transparent 55%),
        linear-gradient(135deg, rgba(20,20,23,.08), rgba(20,20,23,.02));
      display:flex;
      align-items:flex-end;
      padding: 12px;
    }
    .pBadge{
      background: rgba(255,255,255,.78);
      border: 1px solid var(--line);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 950;
      letter-spacing:.2px;
      backdrop-filter: blur(10px);
    }
    .pBody{
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap: 6px;
      flex: 1 1 auto;
      min-width: 0;
    }
    .pName{
      font-weight: 950;
      letter-spacing: .2px;
      font-size: 15px;
      line-height: 1.2;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .pDesc{
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.35;
      min-height: 34px;
    }
    .pBottom{
      margin-top: auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .pPrice{
      font-weight: 950;
      letter-spacing: .2px;
      white-space: nowrap;
    }

    .btnSmall{
      width:auto;
      border: 1px solid var(--line);
      background: rgba(20,20,23,.06);
      color: var(--text);
      border-radius: 16px;
      padding: 10px 12px;
      font-weight: 950;
      cursor:pointer;
      transition: transform .18s ease, box-shadow .18s ease, background .18s ease;
      user-select:none;
      white-space: nowrap;
    }
    .btnSmall:active{ transform: scale(.98); }

    /* pages */
    .view{
      transition: opacity .18s ease, transform .18s ease;
    }
    .hidden{
      opacity: 0;
      transform: translateY(8px);
      pointer-events: none;
      position: absolute;
      left: -9999px;
    }

    .card{
      background: rgba(255,255,255,.84);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      min-width: 0;
    }

    .btn{
      width:100%;
      border:0;
      border-radius: 18px;
      padding: 14px;
      font-weight: 950;
      letter-spacing: .2px;
      cursor:pointer;
      background: linear-gradient(180deg, #141417, #0f0f12);
      color:#fff;
      box-shadow: 0 12px 30px rgba(20,20,23,.18);
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .btn:active{ transform: scale(.98); }

    .btn2{
      width:100%;
      border:1px solid var(--line);
      border-radius: 18px;
      padding: 14px;
      font-weight: 950;
      cursor:pointer;
      background: rgba(20,20,23,.06);
      color: var(--text);
      transition: transform .18s ease;
    }
    .btn2:active{ transform: scale(.98); }

    .two{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 420px){
      .two{ grid-template-columns: 1fr; }
    }

    /* bottom bar */
    .bar{
      position: fixed;
      left:0; right:0; bottom:0;
      z-index: 60;
      padding: 12px 14px calc(12px + env(safe-area-inset-bottom));
      background: rgba(246,245,243,.82);
      backdrop-filter: blur(14px);
      border-top: 1px solid var(--line);
    }
    .barInner{
      max-width: 980px;
      margin: 0 auto;
    }
    .barHint{
      text-align:center;
      color: var(--muted);
      font-size: 12.5px;
      margin-top: 8px;
    }

    /* toast */
    #toast{
      position: fixed;
      left: 50%;
      bottom: calc(92px + env(safe-area-inset-bottom));
      transform: translateX(-50%) translateY(10px);
      background: rgba(20,20,23,.92);
      color: #fff;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 13px;
      opacity: 0;
      transition: opacity .18s ease, transform .18s ease;
      box-shadow: 0 12px 30px rgba(0,0,0,.18);
      z-index: 9999;
      white-space: nowrap;
      max-width: calc(100vw - 24px);
      overflow:hidden;
      text-overflow: ellipsis;
    }
    #toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* stagger appear */
    @keyframes fadeUp{
      from{ opacity:0; transform: translateY(10px); }
      to{ opacity:1; transform: translateY(0); }
    }
    .appear{
      animation: fadeUp .28s ease both;
    }

    /* flying dot */
    .flyDot{
      position: fixed;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: rgba(20,20,23,.86);
      z-index: 10000;
      pointer-events: none;
      box-shadow: 0 8px 18px rgba(20,20,23,.20);
    }
  </style>
</head>

<body>
<header>
  <div class="container">
    <div class="head">
      <div class="brand">
        <div class="title">Studio Wear</div>
        <div class="subtitle">Elegant dancewear ‚Ä¢ –≤–∏—Ç—Ä–∏–Ω–∞ –≤ Telegram (–¥–µ–º–æ)</div>
      </div>
      <div class="pill" id="cartPill" role="button" onclick="go('cart')">
        <small>–ö–æ—Ä–∑–∏–Ω–∞</small> <span id="cartCount">0</span>
      </div>
    </div>
  </div>
</header>

<div id="toast">–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É</div>

<main class="container">
  <!-- CATALOG -->
  <div id="viewCatalog" class="view">
    <div class="toolbar">
      <div class="row">
        <input id="search" placeholder="–ü–æ–∏—Å–∫: —Ç–æ–ø, –ª–µ–≥–∏–Ω—Å—ã, –∫–æ–º–ø–ª–µ–∫—Ç‚Ä¶" oninput="applyFilters()" />
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="chip active" id="chip_all" onclick="setCategory('all')">–í—Å–µ</button>
        <button class="chip" id="chip_sets" onclick="setCategory('sets')">–ö–æ–º–ø–ª–µ–∫—Ç—ã</button>
        <button class="chip" id="chip_tops" onclick="setCategory('tops')">–¢–æ–ø—ã</button>
        <button class="chip" id="chip_leggings" onclick="setCategory('leggings')">–õ–µ–≥–∏–Ω—Å—ã</button>
        <button class="chip" id="chip_leotards" onclick="setCategory('leotards')">–ö—É–ø–∞–ª—å–Ω–∏–∫–∏</button>
      </div>
    </div>

    <div class="grid" id="catalog"></div>
  </div>

  <!-- PRODUCT -->
  <div id="viewProduct" class="view hidden">
    <div class="card">
      <button class="btn2" onclick="go('catalog')" style="margin-top:0;">‚Üê –ù–∞–∑–∞–¥</button>

      <div class="pImg" id="pImg" style="height:240px; border-radius:18px; margin-top:12px;">
        <div class="pBadge" id="pBadge">Studio</div>
      </div>

      <div style="margin-top:12px;">
        <div style="font-size: clamp(18px, 4.2vw, 22px); font-weight: 950; letter-spacing:.2px;" id="pName">‚Äî</div>
        <div class="subtitle" style="margin-top:6px;" id="pDesc">‚Äî</div>

        <div class="row" style="margin-top:14px;">
          <div class="pill" id="pPrice" style="margin-left:0;">‚Äî</div>
          <div class="pill" id="pMeta" style="margin-left:0;">‚Äî</div>
        </div>

        <button class="btn" onclick="addToCart(window.__currentProductId, true)" style="margin-top:14px;">
          –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É
        </button>
      </div>
    </div>
  </div>

  <!-- CART -->
  <div id="viewCart" class="view hidden">
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div style="font-size:18px; font-weight:950;">–ö–æ—Ä–∑–∏–Ω–∞</div>
        <div class="pill" id="cartTotal">–ò—Ç–æ–≥–æ: 0‚ÇΩ</div>
      </div>

      <div id="cartList" style="margin-top:10px;"></div>

      <button class="btn" onclick="go('checkout')" style="margin-top:12px;">
        –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é
      </button>
      <button class="btn2" onclick="go('catalog')" style="margin-top:10px;">
        ‚Üê –ù–∞–∑–∞–¥ –≤ –∫–∞—Ç–∞–ª–æ–≥
      </button>
    </div>
  </div>

  <!-- CHECKOUT -->
  <div id="viewCheckout" class="view hidden">
    <div class="card">
      <button class="btn2" onclick="go('cart')" style="margin-top:0;">‚Üê –ù–∞–∑–∞–¥</button>

      <div style="font-size:18px; font-weight:950; margin:12px 0 6px;">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ (–¥–µ–º–æ)</div>

      <div class="two">
        <div>
          <div class="subtitle" style="margin:6px 0;">–ò–º—è</div>
          <input id="name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–∞—à–∞" />
        </div>
        <div>
          <div class="subtitle" style="margin:6px 0;">–¢–µ–ª–µ—Ñ–æ–Ω</div>
          <input id="phone" placeholder="+7 ..." />
        </div>
      </div>

      <div class="subtitle" style="margin:10px 0 6px;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (—Ä–∞–∑–º–µ—Ä/—Ü–≤–µ—Ç/–¥–æ—Å—Ç–∞–≤–∫–∞)</div>
      <textarea id="comment" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Ä–∞–∑–º–µ—Ä M, –¥–æ—Å—Ç–∞–≤–∫–∞ –°–î–≠–ö"></textarea>

      <button class="btn" onclick="sendOrder()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑ –≤ Telegram</button>

      <div class="subtitle" style="margin-top:10px;">
        * –ü–æ–∫–∞ –¥–µ–º–æ: –±–µ–∑ –æ–ø–ª–∞—Ç—ã. –î–∞–ª—å—à–µ –ø–æ–¥–∫–ª—é—á–∏–º –°–ë–ü/–∫–∞—Ä—Ç—ã –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã.
      </div>
    </div>
  </div>
</main>

<div class="bar">
  <div class="barInner">
    <button class="btn" onclick="go('cart')">–ö–æ—Ä–∑–∏–Ω–∞</button>
    <div class="barHint">–ë–µ–∑ —Å–∞–π—Ç–∞ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ‚Ä¢ –ø—Ä—è–º–æ –≤ Telegram</div>
  </div>
</div>

<script>
  // =============================
  // –ù–ê–°–¢–†–û–ô–ö–ò
  // =============================
  const OWNER_USERNAME = "egorkrab"; // <-- –ø–æ–º–µ–Ω—è–π –Ω–∞ username –≤–ª–∞–¥–µ–ª–∏—Ü—ã (–±–µ–∑ @)

  // =============================
  // –î–ê–ù–ù–´–ï (–¥–µ–º–æ)
  // =============================
  const PRODUCTS = [
    { id:"set1", cat:"sets", badge:"Studio", name:"Silk Line Set", desc:"–ö–æ–º–ø–ª–µ–∫—Ç ‚Ä¢ –º—è–≥–∫–∞—è –ø–æ—Å–∞–¥–∫–∞", price:3490, meta:"XS‚ÄìL ‚Ä¢ ivory/black" },
    { id:"set2", cat:"sets", badge:"Elegant", name:"Contour Set", desc:"–ö–æ–º–ø–ª–µ–∫—Ç ‚Ä¢ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–µ—Ç –ª–∏–Ω–∏—é", price:3790, meta:"XS‚ÄìL ‚Ä¢ black" },
    { id:"set3", cat:"sets", badge:"Core", name:"Minimal Set", desc:"–ö–æ–º–ø–ª–µ–∫—Ç ‚Ä¢ –±–∞–∑–æ–≤—ã–π —Å—Ç—É–¥–∏–π–Ω—ã–π", price:3290, meta:"XS‚ÄìL ‚Ä¢ sand" },

    { id:"leo1", cat:"leotards", badge:"Elegant", name:"Contour Leotard", desc:"–ö—É–ø–∞–ª—å–Ω–∏–∫ ‚Ä¢ –ø–æ—Å–∞–¥–∫–∞ –ø–æ —Ñ–∏–≥—É—Ä–µ", price:2590, meta:"XS‚ÄìL ‚Ä¢ black" },
    { id:"leo2", cat:"leotards", badge:"Studio", name:"Line Leotard", desc:"–ö—É–ø–∞–ª—å–Ω–∏–∫ ‚Ä¢ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–∞—è —Ç–∫–∞–Ω—å", price:2390, meta:"XS‚ÄìL ‚Ä¢ ivory" },

    { id:"top1", cat:"tops", badge:"Soft", name:"Studio Top", desc:"–¢–æ–ø ‚Ä¢ –º—è–≥–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞", price:1490, meta:"XS‚ÄìM ‚Ä¢ 3 —Ü–≤–µ—Ç–∞" },
    { id:"top2", cat:"tops", badge:"Core", name:"Classic Top", desc:"–¢–æ–ø ‚Ä¢ –±–∞–∑–æ–≤—ã–π —Å–∏–ª—É—ç—Ç", price:1390, meta:"XS‚ÄìL ‚Ä¢ black" },

    { id:"leg1", cat:"leggings", badge:"Core", name:"High Waist Leggings", desc:"–õ–µ–≥–∏–Ω—Å—ã ‚Ä¢ –≤—ã—Å–æ–∫–∞—è –ø–æ—Å–∞–¥–∫–∞", price:1990, meta:"XS‚ÄìL ‚Ä¢ black" },
    { id:"leg2", cat:"leggings", badge:"Studio", name:"Second Skin Leggings", desc:"–õ–µ–≥–∏–Ω—Å—ã ‚Ä¢ –∫–∞–∫ –≤—Ç–æ—Ä–∞—è –∫–æ–∂–∞", price:2190, meta:"XS‚ÄìL ‚Ä¢ sand" },
    { id:"leg3", cat:"leggings", badge:"Soft", name:"Smooth Leggings", desc:"–õ–µ–≥–∏–Ω—Å—ã ‚Ä¢ –º—è–≥–∫–∞—è —Ç–∫–∞–Ω—å", price:1890, meta:"XS‚ÄìL ‚Ä¢ ivory" },
  ];

  // =============================
  // –ö–û–†–ó–ò–ù–ê
  // =============================
  const CART_KEY = "studio_shop_cart_v2";
  function getCart(){ return JSON.parse(localStorage.getItem(CART_KEY) || "{}"); }
  function setCart(c){ localStorage.setItem(CART_KEY, JSON.stringify(c)); updateUI(); }

  function cartCount(){
    const c = getCart();
    return Object.values(c).reduce((a,b)=>a+b,0);
  }

  function cartSummary(){
    const c = getCart();
    let total = 0;
    const items = [];
    for (const [id, qty] of Object.entries(c)){
      const p = PRODUCTS.find(x=>x.id===id);
      if(!p) continue;
      total += p.price * qty;
      items.push({ p, qty });
    }
    return { items, total };
  }

  function removeFromCart(id){
    const c = getCart();
    if (!c[id]) return;
    c[id] -= 1;
    if (c[id] <= 0) delete c[id];
    setCart(c);
    haptic("impact");
  }

  // =============================
  // UI HELPERS
  // =============================
  function haptic(type){
    try{
      const H = window.Telegram?.WebApp?.HapticFeedback;
      if(!H) return;
      if(type === "impact") H.impactOccurred("light");
      if(type === "success") H.notificationOccurred("success");
    }catch(e){}
  }

  function showToast(text="–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É"){
    const t = document.getElementById("toast");
    t.textContent = text;
    t.classList.add("show");
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=>t.classList.remove("show"), 1200);
  }

  function bumpCart(){
    const pill = document.getElementById("cartPill");
    pill.classList.remove("bump");
    void pill.offsetWidth;
    pill.classList.add("bump");
  }

  function flyToCart(fromEl){
    if(!fromEl) return;

    const pill = document.getElementById("cartPill");
    const a = fromEl.getBoundingClientRect();
    const b = pill.getBoundingClientRect();

    const dot = document.createElement("div");
    dot.className = "flyDot";
    dot.style.left = (a.left + a.width/2 - 5) + "px";
    dot.style.top  = (a.top + a.height/2 - 5) + "px";
    document.body.appendChild(dot);

    const startX = a.left + a.width/2;
    const startY = a.top + a.height/2;
    const endX = b.left + b.width/2;
    const endY = b.top + b.height/2;

    const dx = endX - startX;
    const dy = endY - startY;

    const duration = 420;
    const start = performance.now();

    function step(t){
      const p = Math.min(1, (t - start)/duration);
      // easeOutCubic
      const e = 1 - Math.pow(1 - p, 3);

      // –ª—ë–≥–∫–∞—è –¥—É–≥–∞
      const arc = Math.sin(p * Math.PI) * -60;

      dot.style.transform = `translate(${dx*e}px, ${dy*e + arc}px) scale(${1 - 0.4*p})`;
      dot.style.opacity = String(1 - 0.2*p);

      if(p < 1) requestAnimationFrame(step);
      else dot.remove();
    }
    requestAnimationFrame(step);
  }

  // =============================
  // –ù–ê–í–ò–ì–ê–¶–ò–Ø (—Å—Ç—Ä–∞–Ω–∏—Ü—ã)
  // =============================
  function showView(name){
    const map = {
      catalog: "viewCatalog",
      product: "viewProduct",
      cart: "viewCart",
      checkout: "viewCheckout",
    };
    Object.values(map).forEach(id => document.getElementById(id).classList.add("hidden"));
    document.getElementById(map[name]).classList.remove("hidden");
    updateUI();
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function go(name){
    location.hash = name === "catalog" ? "#/" : `#/${name}`;
  }

  function handleRoute(){
    const h = (location.hash || "#/").replace("#/","");
    const page = h || "catalog";
    if(page === "product") showView("product");
    else if(page === "cart") showView("cart");
    else if(page === "checkout") showView("checkout");
    else showView("catalog");
  }
  window.addEventListener("hashchange", handleRoute);

  // =============================
  // –ö–ê–¢–ê–õ–û–ì / –§–ò–õ–¨–¢–†–´
  // =============================
  let currentCategory = "all";

  function setCategory(cat){
    currentCategory = cat;
    ["all","sets","tops","leggings","leotards"].forEach(x=>{
      const el = document.getElementById("chip_"+x);
      if(el) el.classList.toggle("active", x===cat);
    });
    applyFilters();
    haptic("impact");
  }

  function applyFilters(){
    const q = (document.getElementById("search")?.value || "").trim().toLowerCase();
    const filtered = PRODUCTS.filter(p=>{
      const matchCat = currentCategory === "all" || p.cat === currentCategory;
      const matchQ = !q || (p.name + " " + p.desc + " " + p.badge).toLowerCase().includes(q);
      return matchCat && matchQ;
    });
    renderCatalog(filtered);
  }

  function renderCatalog(list = PRODUCTS){
    const el = document.getElementById("catalog");
    el.innerHTML = "";

    list.forEach((p, i)=>{
      const card = document.createElement("div");
      card.className = "productCard appear";
      card.style.animationDelay = (Math.min(i, 12) * 22) + "ms";

      card.innerHTML = `
        <div class="pImg" data-open="${p.id}">
          <div class="pBadge">${p.badge}</div>
        </div>
        <div class="pBody">
          <div class="pName" title="${p.name}">${p.name}</div>
          <div class="pDesc">${p.desc}</div>
          <div class="pBottom">
            <div class="pPrice">${p.price}‚ÇΩ</div>
            <button class="btnSmall" data-add="${p.id}">+ –í –∫–æ—Ä–∑–∏–Ω—É</button>
          </div>
        </div>
      `;

      el.appendChild(card);
    });

    // –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–∫–æ–≤
    el.querySelectorAll("[data-open]").forEach(img=>{
      img.addEventListener("click", ()=> openProduct(img.getAttribute("data-open")));
    });
    el.querySelectorAll("[data-add]").forEach(btn=>{
      btn.addEventListener("click", (e)=>{
        e.stopPropagation();
        const id = btn.getAttribute("data-add");
        addToCart(id, false, btn);
      });
    });
  }

  // =============================
  // –¢–û–í–ê–†
  // =============================
  function openProduct(id){
    const p = PRODUCTS.find(x=>x.id===id);
    if(!p) return;

    window.__currentProductId = id;

    document.getElementById("pBadge").textContent = p.badge;
    document.getElementById("pName").textContent = p.name;
    document.getElementById("pDesc").textContent = p.desc;
    document.getElementById("pPrice").textContent = `${p.price}‚ÇΩ`;
    document.getElementById("pMeta").textContent = p.meta;

    go("product");
    haptic("impact");
  }

  // =============================
  // ADD TO CART
  // =============================
  function addToCart(id, fromProductPage=false, fromEl=null){
    const c = getCart();
    c[id] = (c[id] || 0) + 1;
    setCart(c);

    const p = PRODUCTS.find(x=>x.id===id);
    showToast(p ? `–í –∫–æ—Ä–∑–∏–Ω–µ: ${p.name}` : "–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É");
    bumpCart();
    haptic("success");

    // –ª–µ—Ç—è—â–∞—è —Ç–æ—á–∫–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–∫—É–¥–∞ –ª–µ—Ç–µ—Ç—å)
    if(fromEl) flyToCart(fromEl);
    else if(fromProductPage){
      // –µ—Å–ª–∏ —Å product page ‚Äî –ª–µ—Ç–∏–º –æ—Ç –±–æ–ª—å—à–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏
      flyToCart(document.getElementById("pImg"));
    }
  }

  // =============================
  // UPDATE UI
  // =============================
  function updateUI(){
    const count = cartCount();
    document.getElementById("cartCount").textContent = String(count);

    const cartList = document.getElementById("cartList");
    const cartTotal = document.getElementById("cartTotal");
    if(cartList && cartTotal){
      const { items, total } = cartSummary();
      cartTotal.textContent = `–ò—Ç–æ–≥–æ: ${total}‚ÇΩ`;

      if(!items.length){
        cartList.innerHTML = `<div class="subtitle" style="padding:10px 0;">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è.</div>`;
        cartTotal.textContent = `–ò—Ç–æ–≥–æ: 0‚ÇΩ`;
      } else {
        cartList.innerHTML = items.map(({p, qty})=>{
          return `
            <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 0; border-bottom:1px solid var(--line);">
              <div style="min-width:0;">
                <div style="font-weight:950; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${p.name}</div>
                <div class="subtitle">${p.price}‚ÇΩ ‚Ä¢ ${p.meta}</div>
              </div>
              <div class="row" style="gap:8px; flex:0 0 auto; flex-wrap:nowrap;">
                <button class="btnSmall" onclick="removeFromCart('${p.id}')">‚àí</button>
                <div class="pill" style="margin:0;">${qty}</div>
                <button class="btnSmall" onclick="addToCart('${p.id}')">+</button>
              </div>
            </div>
          `;
        }).join("");
      }
    }
  }

  // =============================
  // SEND ORDER (–¥–µ–º–æ)
  // =============================
  function sendOrder(){
    const { items, total } = cartSummary();
    if(!items.length){ alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è üòÖ"); return; }

    const name = document.getElementById("name").value.trim() || "‚Äî";
    const phone = document.getElementById("phone").value.trim() || "‚Äî";
    const comment = document.getElementById("comment").value.trim() || "‚Äî";

    const lines = items.map(({p, qty}) => `${p.name} √ó ${qty} = ${p.price*qty}‚ÇΩ`).join("\n- ");

    const text =
`üõçÔ∏è –ó–∞–∫–∞–∑ (–¥–µ–º–æ)
–ò–º—è: ${name}
–¢–µ–ª–µ—Ñ–æ–Ω: ${phone}

–¢–æ–≤–∞—Ä—ã:
- ${lines}

–ò—Ç–æ–≥–æ: ${total}‚ÇΩ
–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${comment}`;

    const url = `https://t.me/${OWNER_USERNAME}?text=${encodeURIComponent(text)}`;

    if (window.Telegram?.WebApp?.openTelegramLink) {
      window.Telegram.WebApp.openTelegramLink(url);
    } else {
      window.open(url, "_blank");
    }

    haptic("success");
  }

  // =============================
  // INIT
  // =============================
  renderCatalog(PRODUCTS);
  applyFilters();
  handleRoute();
  updateUI();
</script>
</body>
</html>

